{% extends 'base.html' %}

{% block content %}
    <div class="container-fluid text-center" style="padding-top:2rem;" data-pid="{{ playlist.id }}" id="playlist-page">
        <div class="row">
            <div class="col-auto" style="min-width: 174px;">
                <img src="{{ url_for('static', filename='uploads/' ~ playlist.image) }}" class="responsive-cover rounded-start rounded-end" alt="...">

                <div class="container-fluid" >
                    <br>
                    <h1>{{playlist.title}}</h1>
                    <p>{{playlist.creator}}<br>{{playlist.description}}</p>
                </div>

            </div>
             <div class="col">
                <br>
                <h1>Songs</h1>
                <div class="container-fluid" >
                    <div class="row row-cols-1">
                    {% for song in data %}
                        
                        <div class="card mb-3 bg-black text-light" style="height: 18rem;">
                            <div class="row">
                                <div class="col-md-4" style="padding: 0px">
                                <img 
                                {% if song.releases is defined and song.releases %}
                                    src="{{"https://coverartarchive.org/release/" ~ song.releases[0].id ~ "/front"}}"
                                {% else %}
                                    src="{{url_for('static', filename='images/placeholder.jpg')}}"
                                {% endif %}
                                
                                class="responsive-img rounded-start" alt="...">
                                </div>
                                <div class="col-md-8">
                                <div class="card-body">
                                    <h5 class="card-title">{{song.title}}</h5>
                                    {% if song["artist-credit"] is defined and song["artist-credit"]%}
                                        <p class="card-text">{{ song["artist-credit"][0].name }}</p>
                                    {% endif %}
                                    {% if song.releases is defined and song.releases %}
                                        <p class="card-text">{{song.releases[0].title}}</p>
                                    {% endif %}
                                    <a href="#" class="btn btn-primary rmv-btn" data-mbid="{{ song.id }}">Remove</a>

                                    <p class="card-text"><small class="text-body-secondary">Kanesite</small></p>
                                </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
        const page = document.getElementById("playlist-page");
        const playlistId = page.getAttribute("data-pid");

        document.querySelectorAll(".rmv-btn").forEach(button => {
            button.addEventListener("click", function(event) {
            event.preventDefault();
            const mbid = this.getAttribute("data-mbid");

            fetch(`/api/playlists/${playlistId}/remove_song`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ mbid: mbid })
            })
            .then(res => res.json())
            .then(data => {
                console.log(data);
                // Option A: reload the whole page
                location.reload();
                // Option B: re-fetch just the playlist HTML and replace #playlist-page
                // refreshPlaylistPage(playlistId);
            })
            .catch(err => console.error(err));
            });
        });
        });

    </script>

            
     <script>
      const placeholder = "{{ url_for('static', filename='images/placeholder.jpg') }}";

      document.querySelectorAll('.responsive-img').forEach(img => {
        img.onload = () => {
          img.style.backgroundImage = 'none';
        };
        img.onerror = () => {
          img.onerror = null;
          img.src = placeholder;
          img.style.backgroundImage = 'none';
        };
        });
    </script>

    {% endblock %}